{% extends "diary/base.html" %}
{% load django_bootstrap5 %}

{% block title %}
    地域選択
{% endblock title %}

{% block content %}
    <h2>キーワードから地域を探す</h2>
    <div class="search-wrapper">
        <div class="user-search-form">
            <form method="get">
                {% csrf_token %}
                <input type="search" value="{{request.GET.query}}" name="query" type="text" placeholder=" 地名・施設名・駅名など">
                <button class="btn search-icon">検索</button>
            </form>
        </div>
        <div class="address-table-wrapper">
            <table>
                <tbody id="address-table-body">
                </tbody>
            </table>
        </div>
    </div>
{% endblock content %}

{% block extra_js %}
    <script src="{% static 'diary/js/getCookie.js' %}"></script>
    <script>
        $('.user-search-form .search-icon').on('click',function(){
            var csrftoken = getCookie('csrftoken');

            $('.address-table tbody').empty();
            $('.search-null').remove()

            let addressName = $('#search_name').val();

            if(!addressName){
                return false;
            }

            $.ajax({
                type: "GET",
                url: "diary/ajax/address_search/",
                headers: {
                    "X-CSRFToken": csrftoken  // CSRFトークンをヘッダーに追加
                },
                data: {
                    "name":addressName,
                    'csrfmiddlewaretoken': csrftoken  // フォームの場合と同じように、CSRFトークンを含める
                },
                dataType: 'json',
                beforeSend: function(){
                    $('.loading').removeClass('display-none');
                },
                success: function(data_list){
                    $('.loading').addClass('display-none');
                    let address_table = document.getElementById("address-table-body")
                    for (const data of data_list) {
                        let lat = data.lat;
                        let lon = data.lon;
                        let label = data.label
                        let html = '<tr><td>' + label + '</td></tr>';
                        address_table.append(html);
                    }
                },
            });
        })

    </script>
{% endblock %}