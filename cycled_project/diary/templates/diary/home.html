{% extends "diary/base.html" %}
{% load django_bootstrap5 %}
{% load static %}

{% block title %}
    ほーむぺーじ
{% endblock title %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'diary/css/home.css' %}" type="text/css" >
{% endblock extra_css %}

{% block content %}
    <div class="container">
        {% if not user.home %}
        <div>
            <p>住所が登録されていません</p>
            <p>住所を登録することで天気を見ることができます</p>
            <a href="{% url 'diary:address_home' %}">新しく登録する</a>
        </div>
        {% else %}
        <div class = "row">
            <div class="col">
                <p>{{user.home.display}}（{{user.home.state}}）</p>
                <a href="{% url 'diary:address_home' %}">住所を変更する</a>
            </div>
            <div class="col">
                <div id="currentWeather"></div>
            </div>
        </div>

        {% comment %} <div class="row justify-content-md-center text-center">
            <div class="col text-center align-middle">
                <h3>今日の天気</h3>
                <div id="getTodayWeather"></div>
            </div>
            <div class="col text-center align-middle">
                <h3>明日の天気</h3>
                <div id="getTomorrowWeather"></div>
            </div>
        </div> {% endcomment %}

        <div class="weather-table-hourly table-responsive row justify-content-md-center mt-3">
            <div class="col-md-auto">
                <table class="table text-center" id="weather_table_hourly"></table>
            </div>
        </div>

        {% endif %}
        
    </div>
{% endblock content %}

{% block extra_js %}
    <script src="{% static 'diary/js/getCookie.js' %}"></script>
    <script src="{% static 'diary/js/loading_overlay.js' %}"></script>
    <script>
        $(document).ready(sendLocationToServer({{ user.home.lat }}, {{ user.home.lon }}));

        function sendLocationToServer(lat,lon) {
            start_loading(false);
        
            // ここからAjaxリクエストの処理
            var csrftoken = getCookie('csrftoken');
            
            $.ajax({
                method: "POST",
                url: "{% url 'diary:ajax_location2weather' %}",
                headers: {
                    "X-CSRFToken": csrftoken  // CSRFトークンも必要な場合
                },
                data: {
                    'latitude': lat,
                    'longitude': lon,
                    'csrfmiddlewaretoken': csrftoken  // フォームの場合と同じように、CSRFトークンを含める
                },
                dataType: 'json',
                timeout:15000,
            })
        
            .done(function(data_raw) {
                //Loadingアイコン削除
                remove_loading();
                var data = data_raw.weather
                var today = `
                <h4>${data.today.time.month}/${data.today.time.day}</h4>
                <img src="${data.today.img_file_path}" alt="today_weather" width="100px" height="100px" class="ms-auto">
                `;
                var tomorrow =  `
                <h4>${data.tomorrow.time.month}/${data.tomorrow.time.day}</h4>
                <img src="${data.tomorrow.img_file_path}" alt="tomorrow_weather" width="100px" height="100px" class="ms-auto">
                `;
                $('#getTodayWeather').append(today);
                $('#getTomorrowWeather').append(tomorrow);
                
                $('#weather_table_hourly').html(template(data.hourly))
            })
        
            .fail(function(jqXHR, textStatus, errorThrown) {
                //Loadingアイコン削除
                remove_loading();
                // エラーメッセージを表示
                console.error("Error sending location data:", errorThrown);
            });
        
        };

        function template(dataArray){
            var table = `
                <thead>
                    <tr id="time"><th scope="col">時刻</th></tr>
                </thead>
                <tbody>
                    <tr id="img-and-day"><td scope="row"></td></tr>
                    <tr id="tempareture"><td scope="row">気温</td></tr>
                    <tr id="precipitation_probability"><td scope="row">降水確率</td></tr>
                    <tr id="precipitation"><td scope="row">降水量</td></tr>
                    <tr id="wind"><td scope="row">風</td></tr>
                </tbody>
            `;
            var tObject = $(table);

            dataArray.map(function(data,index){
                
                if(data.time.hour == 0){
                    var colClass = `daily-column`;
                    var elements = [
                        { id: '#time', content: `<th scope="col" class=${colClass}></th>` },
                        { id: '#img-and-day', content: `<td rowspan="5" scope="row" class="align-top ${colClass}">${data.time.day}日</td>` },
                    ];
                    elements.forEach(({ id, content }) => {
                        tObject.find(id).append(content);
                    });
                } 
                var colClass = `hourly-column`
                var windImageMap = {
                    0: "{% static 'diary/img/arrow0.png' %}",
                    1: "{% static 'diary/img/arrow1.png' %}",
                    2: "{% static 'diary/img/arrow2.png' %}",
                    3: "{% static 'diary/img/arrow3.png' %}",
                    error: "{% static 'diary/img/error.png' %}"
                };
                var getWindImage = (speed) => {
                    if (speed < 3) return windImageMap[0];
                    if (speed < 7) return windImageMap[1];
                    if (speed < 10) return windImageMap[2];
                    if (speed >= 10) return windImageMap[3];
                    return windImageMap['error'];
                };
                
                var windImageSrc = getWindImage(data.wind_speed_10m);
                
                var elements = [
                    { id: '#time', content: `<th scope="col" class=${colClass}>${data.time.hour}</th>` },
                    { id: '#img-and-day', content: `<td scope="row" class=${colClass}><img src="${data.img_file_path}" alt="weather" width="40px" height="40px" class="ms-auto"></td>` },
                    { id: '#tempareture', content: `<td scope="row" class=${colClass}>${data.temperature_2m}℃</td>` },
                    { id: '#precipitation', content: `<td scope="row" class=${colClass}>${data.precipitation === 0 ? 'ー' : `${data.precipitation}mm`}</td>` },
                    { id: '#precipitation_probability', content: `<td scope="row" class=${colClass}>${data.precipitation_probability}%</td>` },
                    { 
                        id: '#wind', 
                        content: `
                            <td scope="row" class="text-center align-middle ${colClass}">
                                <img src="${windImageSrc}" alt="wind" width="40px" height="40px" class="ms-auto" style="transform:rotate(${data.wind_direction_10m}deg);">
                                <br>
                                ${data.wind_speed_10m}m/s
                            </td>`
                    },
                ];
                
                elements.forEach(({ id, content }) => {
                    tObject.find(id).append(content);
                });
            })
            return tObject
        }
    </script>
{% endblock %}