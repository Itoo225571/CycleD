{% extends "diary/base.html" %}
{% load django_bootstrap5 %}
{% load static %}

{% block title %}
    ほーむぺーじ
{% endblock title %}

{% block content %}
    <div class="container mt-5">
        <div class="row">
            <div class="col my-title">
                <h1>Welcome to さいくるにっき{{user.username}}さん</h1>
            </div>
        </div>
        {% if not user.home %}
        <div>
            <p>住所が登録されていません</p>
            <p>住所を登録することで天気を見ることができます</p>
            <a href="{% url 'diary:address_search' %}">新しく登録する</a>
        </div>
        {% else %}
        <div class="row">
            <h3>{{user.home.display}}</h3>
            <h4>{{user.home.state}}</h4>
            <div class="col-md-6 my-content">
                <h3>今日の天気</h3>
                <p id="getTodayWeather"></p>
            </div>
            <div class="col-md-6 my-content">
                <h3>明日の天気</h3>
                <p id="getTomorrowWeather"></p>
            </div>
            
        </div>
        {% endif %}
        
    </div>
{% endblock content %}

{% block extra_js %}
    <script src="{% static 'diary/js/getCookie.js' %}"></script>

    <script>
        
        // サーバーに位置情報を送信する関数
        function sendLocationToServer(latitude, longitude) {
            // CSRFトークンを取得
            var csrftoken = getCookie('csrftoken');
            
            $.ajax({
                type: "POST",
                url: "diary/ajax/getLocation/",
                headers: {
                    "X-CSRFToken": csrftoken  // CSRFトークンをヘッダーに追加
                },
                data: {
                    'latitude': latitude,
                    'longitude': longitude,
                    'csrfmiddlewaretoken': csrftoken  // フォームの場合と同じように、CSRFトークンを含める
                },
                dataType: 'json',
                success: function(data) {
                    document.getElementById("getTodayWeather").innerHTML         = data.today.weather
                    document.getElementById("getTomorrowWeather").innerHTML        = data.tomorrow.weather
                    document.getElementById("getMessage").innerHTML= data.message
                },
                error: function(xhr, status, error) {
                    console.error("Error sending location data:", error);
                }
            });
        };
        
    </script>

    <script>
        $("form").submit(function(event) {
            // フォームのデフォルトの動作をキャンセル
            event.preventDefault();
        
            // ここからAjaxリクエストの処理
            var csrftoken = getCookie('csrftoken');
            var form = $(this);
            
            $.ajax({
                method: form.prop("method"),
                url: form.prop("action"),
                headers: {
                    "X-Requested-With": "XMLHttpRequest",  // 追加するヘッダー
                    "X-CSRFToken": csrftoken  // CSRFトークンも必要な場合
                },
                data: form.serialize(),
                dataType: 'json',
                timeout:10000,
            })
        
            .done(function(data) {
                // data_list内の各オブジェクトを処理
                $.each(data.data_list, function(index, value) {
                    // オブジェクトのプロパティを取り出して表示
                    $('#address-table-body').append('<p>lat: ' + value.lat + ', lon: ' + value.lon + ', label: ' + value.label + '</p>');
                });
            });
        });
        

    </script>
{% endblock %}