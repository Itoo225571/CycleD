{% extends "diary/base.html" %}
{% load django_bootstrap5 %}
{% load static %}

{% block title %}
    ほーむぺーじ
{% endblock title %}

{% block content %}
    <div class="container mt-5">
        {% if not user.home %}
        <div>
            <p>住所が登録されていません</p>
            <p>住所を登録することで天気を見ることができます</p>
            <a href="{% url 'diary:address' %}">新しく登録する</a>
        </div>
        {% else %}
        <div class = "row justify-content-md-center text-center">
            <div class="col-md-auto">
                <h3>{{user.home.display}}</h3>
                <h4>（{{user.home.state}}）</h4>
                <a href="{% url 'diary:address' %}">住所を変更する</a>
            </div>
        </div>

        <div class="row justify-content-md-center text-center">
            <div class="col">
                <h3>今日の天気</h3>
                <div id="getTodayWeather"></div>
            </div>
            <div class="col">
                <h3>明日の天気</h3>
                <div id="getTomorrowWeather"></div>
            </div>
            
        </div>
        {% endif %}
        
    </div>
{% endblock content %}

{% block extra_js %}
    <script src="{% static 'diary/js/getCookie.js' %}"></script>
    <script>
        
        $(document).ready(sendLocationToServer({{ user.home.lat }}, {{ user.home.lon }}));

        function sendLocationToServer(lat,lon) {
            var loading_today = '<div class="spinner-border text-dark m-4" id="weather-loading_today" role="status"></div> '
            var loading_tomorrow = '<div class="spinner-border text-dark m-4" id="weather-loading_tomorrow" role="status"></div> '
            $('#getTodayWeather').append(loading_today);
            $('#getTomorrowWeather').append(loading_tomorrow);
        
            // ここからAjaxリクエストの処理
            var csrftoken = getCookie('csrftoken');
            
            $.ajax({
                method: "POST",
                url: "{% url 'diary:ajax_location2weather' %}",
                headers: {
                    "X-CSRFToken": csrftoken  // CSRFトークンも必要な場合
                },
                data: {
                    'latitude': lat,
                    'longitude': lon,
                    'csrfmiddlewaretoken': csrftoken  // フォームの場合と同じように、CSRFトークンを含める
                },
                dataType: 'json',
                timeout:15000,
            })
        
            .done(function(data) {
                //Loadingアイコン削除
                $('.spinner-border').remove();
                var today =     '<img src=' + data.today.weather_img + ' alt="today_weather" width="100px" height="100px" class="ms-1 me-4">'
                var tomorrow =  '<img src=' + data.tomorrow.weather_img + ' alt="today_weather" width="100px" height="100px" class="ms-1 me-4">'
                $('#getTodayWeather').append(today);
                $('#getTomorrowWeather').append(tomorrow);
            })
        
            .fail(function(jqXHR, textStatus, errorThrown) {
                //Loadingアイコン削除
                $('.spinner-border').remove();
                // エラーメッセージを表示
                console.error("Error sending location data:", error);
            });
        
        };
    </script>
{% endblock %}