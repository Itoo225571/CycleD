{% extends "diary/base.html" %}
{% load django_bootstrap5 %}
{% load static %}

{% block title %}
    ほーむぺーじ
{% endblock title %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'diary/css/home.css' %}" type="text/css" >
{% endblock extra_css %}

{% block content %}
    <div class="container">
        {% if not user.home %}
        <div>
            <p>住所が登録されていません</p>
            <p>住所を登録することで天気を見ることができます</p>
            <a href="{% url 'diary:address_home' %}">新しく登録する</a>
        </div>
        {% else %}
        <div class = "row justify-content-md-center text-center">
            <div class="col-md-auto">
                <h3>{{user.home.display}}</h3>
                <h4>（{{user.home.state}}）</h4>
                <a href="{% url 'diary:address_home' %}">住所を変更する</a>
            </div>
        </div>

        <div class="row justify-content-md-center text-center">
            <div class="col text-center align-middle">
                <h3>今日の天気</h3>
                <div id="getTodayWeather"></div>
            </div>
            <div class="col text-center align-middle">
                <h3>明日の天気</h3>
                <div id="getTomorrowWeather"></div>
            </div>
        </div>

        <div class="weather-table-hourly table-responsive row justify-content-md-center m-3">
            <div class="col-md-auto">
                <table class="table text-center" id="weather_table_hourly"></table>
            </div>
        </div>

        {% endif %}
        
    </div>
{% endblock content %}

{% block extra_js %}
    <script src="{% static 'diary/js/getCookie.js' %}"></script>
    <script>
        $(document).ready(sendLocationToServer({{ user.home.lat }}, {{ user.home.lon }}));

        function sendLocationToServer(lat,lon) {
            var loading_today = '<div class="spinner-border text-dark m-4" id="weather-loading_today" role="status"></div> '
            var loading_tomorrow = '<div class="spinner-border text-dark m-4" id="weather-loading_tomorrow" role="status"></div> '
            $('#getTodayWeather').append(loading_today);
            $('#getTomorrowWeather').append(loading_tomorrow);
        
            // ここからAjaxリクエストの処理
            var csrftoken = getCookie('csrftoken');
            
            $.ajax({
                method: "POST",
                url: "{% url 'diary:ajax_location2weather' %}",
                headers: {
                    "X-CSRFToken": csrftoken  // CSRFトークンも必要な場合
                },
                data: {
                    'latitude': lat,
                    'longitude': lon,
                    'csrfmiddlewaretoken': csrftoken  // フォームの場合と同じように、CSRFトークンを含める
                },
                dataType: 'json',
                timeout:15000,
            })
        
            .done(function(data_raw) {
                //Loadingアイコン削除
                $('.spinner-border').remove();
                var data = data_raw.weather
                var today = `
                <h4>${data.today.time.month}/${data.today.time.day}</h4>
                <img src="${data.today.img_file_path}" alt="today_weather" width="100px" height="100px" class="ms-auto">
                `;
                var tomorrow =  `
                <h4>${data.tomorrow.time.month}/${data.tomorrow.time.day}</h4>
                <img src="${data.tomorrow.img_file_path}" alt="tomorrow_weather" width="100px" height="100px" class="ms-auto">
                `;
                $('#getTodayWeather').append(today);
                $('#getTomorrowWeather').append(tomorrow);
                
                $('#weather_table_hourly').html(template(data.hourly))
            })
        
            .fail(function(jqXHR, textStatus, errorThrown) {
                //Loadingアイコン削除
                $('.spinner-border').remove();
                // エラーメッセージを表示
                console.error("Error sending location data:", error);
            });
        
        };

        function template(dataArray){
            var table = `
                <thead style="border-bottom: 1px solid #000000; /* 下側のボーダーを追加 */">
                    <tr id="time"><th scope="col">時刻</th></tr>
                </thead>
                <tbody>
                    <tr id="img"><td scope="row"></td></tr>
                    <tr id="tempareture"><td scope="row">気温</td></tr>
                    <tr id="precipitation_probability"><td scope="row">降水確率</td></tr>
                    <tr id="precipitation"><td scope="row">降水量</td></tr>
                    <tr id="wind"><td scope="row">風</td></tr>
                </tbody>
            `;
            var tObject = $(table);
            dataArray.map(function(data,index){
                var time = `<th scope="col">${data.time.hour}</th>`;
                var img = `<td scope="row"><img src="${data.img_file_path}" alt="weather" width="40px" height="40px" class="ms-auto"></td>`;
                var tempareture = `<td scope="row">${data.temperature_2m}℃</td>`;
                var precipitation = `<td scope="row">${data.precipitation}mm</td>`;
                var precipitation_probability = `<td scope="row">${data.precipitation_probability}%</td>`;
                var wind_src;
                if (data.wind_speed_10m >= 0 && data.wind_speed_10m < 3) {
                    wind_src = "{% static 'diary/img/arrow0.png' %}";
                } else if (data.wind_speed_10m >= 3 && data.wind_speed_10m < 7) {
                    wind_src = "{% static 'diary/img/arrow1.png' %}";
                } else if (data.wind_speed_10m >= 7 && data.wind_speed_10m < 10) {
                    wind_src = "{% static 'diary/img/arrow2.png' %}";
                } else if (data.wind_speed_10m >= 10) {
                    wind_src = "{% static 'diary/img/arrow3.png' %}";
                } else {
                    wind_src = "{% static 'diary/img/error.png' %}";
                }
                var wind = `
                    <td scope="row" class="text-center align-middle">
                        <img src="${wind_src}" alt="wind" width="40px" height="40px" class="ms-auto" style="transform:rotate(${data.wind_direction_10m}deg);">
                        <br>
                        ${data.wind_speed_10m}m/s
                    </td>`;

                tObject.find('#time').append(time);
                tObject.find('#img').append(img); 
                tObject.find('#tempareture').append(tempareture);
                tObject.find('#precipitation').append(precipitation);
                tObject.find('#precipitation_probability').append(precipitation_probability);
                tObject.find('#wind').append(wind);
            })
            return tObject
        }
    </script>
{% endblock %}