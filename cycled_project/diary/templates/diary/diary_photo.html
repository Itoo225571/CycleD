{% extends "diary/base.html" %}
{% load django_bootstrap5 %}
{% load static %}
{% load widget_tweaks %}

{% block title %}
    しんきさくせい
{% endblock title %}

{% block page_title %}
    <h2>日記 新規作成</h2>
{% endblock page_title %}

{% block extra_css %}
    <link href="https://unpkg.com/filepond/dist/filepond.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'diary/css/diary_photo.css' %}" type="text/css" >
{% endblock extra_css %}

{% block content %}
    <div class="container">
        <div class="row"> 
            <form method="post" id="id_photos-form" name="photos-form" enctype="multipart/form-data" >
                {% csrf_token %}
                <div id="photo_form">
                    <div class="row my-3 justify-content-center">
                        <div class="col-10">
                            <!-- {% comment %} <label for="{{ photo_form.images.id_for_label }}">{{ photo_form.images.label }}</label> {% endcomment %} -->
                            <!-- {{ photo_form.images|add_class:"filepond"}} -->
                            <input type="file" class="filepond" name="{{ photo_form.images.name }}" accept=".jpeg, .jpg, .png, .gif, .heic, .heif" multiple>
                            {% if field.errors %}
                                <div class="error">{{ photo_form.images.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </form>

            <div class="row diary-photo-container" style="display: none;">
                <form method="post" id="id_diary-new-form" enctype="multipart/form-data" onsubmit="return false;">
                    {% csrf_token %}
                    <div class="row" id="diary_form">
                        <div id="diary-management">{{ diary_formset.management_form }}</div>
                        <div id="location-management">{{ diary_formset.empty_form.formset.management_form }}</div>
                        <div id="diary-formset-body"></div>
                    </div>

                    <div class="row py-3 justify-content-center">
                        <button type="submit" class="diary-new-button" name="diary-new-form" style="display: none;">
                            <span class="text">日記作成!</span>
                        </button>
                    </div>
                </form>
            </div>

            <div id="empty-form-diary" style="display:none;">
                {{ diary_formset.empty_form.date }}
                {{ diary_formset.empty_form.diary_id }}
                <div class="card" id="id_form-__prefix__-card">
                    <div class="card-header">
                        <h5 class="card-diary-date"></h5>
                        <div id="id_form-__prefix__-diary-errors"></div>
                    </div>
                    
                    <div class="card-body">
                        <h5 class="card-title col-auto">写真で得られた地域一覧</h5>
                        <div class="explanation">
                            <div>地域を選択すると日記のサムネイルを変更できます。</div>
                        </div>
                        <div class="row">
                            <div id="id_form-__prefix__-thumbnail" class="col diary-thumbnail order-md-2"></div>
                            <ul id="id_form-__prefix__-location-formset-body" class="list-group col-12 col-md-7 order-md-1"></ul>
                        </div>
                        <div class="mt-4">
                            <label for="{{ diary_formset.empty_form.comment.id_for_label }}" class="form-label">{{ diary_formset.empty_form.comment.label }}</label>
                            {{ diary_formset.empty_form.comment}}
                        </div>
                    </div>
                </div>
            </div>
            <div id="empty-form-location" style="display:none;">
                {% for field in diary_formset.empty_form.formset.empty_form %}
                    {% if field.name != 'label' %}
                        {{ field }}
                    {% endif %}
                {% endfor %}
                <div class="input-group d-flex flex-row align-items-center">
                    <div class="location-list-label-display w-100"></div>
                    {{ diary_formset.empty_form.formset.empty_form.label|add_class:"w-100 form-control class_locations-label"}}
                </div>
                <div class="d-flex align-items-center">
                    <button type="button" class="btn p-0" onclick="edit_location(this)">
                        <i class="bi bi-pencil-square icon-location"></i>
                    </button> 
                    <button type="button" class="btn p-0" onclick="delete_location(this)">
                        <i class="bi bi-trash icon-location" alt="icon-trash" style="color: crimson;"></i>
                    </button> 
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block extra_js %}
    <!-- FilePondをインストール -->
    {% comment %} これはHeicの関係上導入できない {% endcomment %}
    {% comment %} <script src="https://unpkg.com/filepond-plugin-file-validate-type/dist/filepond-plugin-file-validate-type.js"></script> {% endcomment %}
    {% comment %} サイズ制限 {% endcomment %}
    <script src="https://unpkg.com/filepond-plugin-file-validate-size/dist/filepond-plugin-file-validate-size.js"></script>
    <script src="https://unpkg.com/filepond/dist/filepond.js"></script>
    <script src="{% static 'diary/js/getCookie.js' %}"></script>
    <script src="{% static 'diary/js/loading_overlay.js' %}"></script>
    <script>
        // DjangoテンプレートタグでURLを埋め込む
        const url_photos2Locations = "{% url 'diary:photos2Locations' %}";
        const url_sendDiaries = "{% url 'diary:sendDiaries' %}";
        const MAX_LOCATIONS = {{ MAX_LOCATIONS }}
    </script>
    <script src="{% static 'diary/js/diary_photo.js' %}"></script>
    
{% endblock %}