{% extends "diary/base.html" %}
{% load django_bootstrap5 %}
{% load static %}

{% block title %}
    地域選択
{% endblock title %}

{% block content %}
    <h2>キーワードから地域を探す</h2>
    <div class="search-wrapper">
        <div class="address-search-form">
            <form action="" method="post" >
                {% csrf_token %}
                {{ form }}
                <button class="btn btn-primary m-3" type="submit">検索</button>
            </form>
        </div>
    </div>

    <ul class="list-group" id="address-list"></ul>

    <nav aria-label="pagenator-aria">
        <ul class="pagination"></ul>
    </nav>
    
{% endblock content %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'diary/css/address_search.css' %}">
{% endblock extra_css %}


{% block extra_js %}
    <script src="{% static 'diary/js/getCookie.js' %}"></script>

    <script>
        $("form").submit(function(event) {
            // フォームのデフォルトの動作をキャンセル
            event.preventDefault();
            //前の検索結果を消す
            $('#address-list').children().remove();
            //Loadingアイコン表示
            var loading = '<div class="spinner-border text-dark m-4" id="address-loading" role="status"></div> '
            $('#address-list').append(loading);
            // ここからAjaxリクエストの処理
            var csrftoken = getCookie('csrftoken');
            var form = $(this);
            
            $.ajax({
                method: form.prop("method"),
                url: form.prop("action"),
                headers: {
                    "X-Requested-With": "XMLHttpRequest",  // 追加するヘッダー
                    "X-CSRFToken": csrftoken  // CSRFトークンも必要な場合
                },
                data: form.serialize(),
                dataType: 'json',
                timeout:10000,
            })
        
            .done(function(data) {
                //Loadingアイコン削除
                $('#address-loading').remove();
                // data_list内の各オブジェクトを処理
                $.each(data.data_list, function(index, value) {
                    // オブジェクトのプロパティを取り出して表示
                    var html =  '<button type="button" class="list-group-item list-group-item-action">'+ 
                                //    value.address.name + '(' + value.address.city +')' +
                                value.address.label + " : " + value.address.matcher +
                                '</button>'
                    var pagination
                    
                    $('#address-list').append(html);
                })
            })

            .fail(function(jqXHR, textStatus, errorThrown) {
                //Loadingアイコン削除
                $('#address-loading').remove();
                // エラーメッセージを表示
                $('#address-list').append('<div class="alert alert-danger" role="alert">リクエストがタイムアウトしました。</div>');
            });

        });
        
    </script>
{% endblock %}
